version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: server
      APP_PORT: 18789
    depends_on:
      server:
        condition: service_healthy

  server:
    image: ghcr.io/moltbot/moltbot:main
    init: true
    restart: unless-stopped
    stop_grace_period: 30s
    user: "0:0"
    environment:
      NODE_ENV: production
      HOME: /home/node
      # Gateway authentication token (auto-generated by Umbrel)
      CLAWDBOT_GATEWAY_TOKEN: "${APP_SEED}"
    command:
      - node
      - dist/index.js
      - gateway
      - --bind
      - "0.0.0.0"
      - --port
      - "18789"
      - --allow-unconfigured
    volumes:
      - ${APP_DATA_DIR}/data:/home/node/.moltbot
      - ${APP_DATA_DIR}/workspace:/home/node/clawd
    tmpfs:
      - /tmp/moltbot:uid=0,gid=0
    healthcheck:
      test: ["CMD", "node", "-e", "const http=require('http');const r=http.get('http://localhost:18789/__moltbot__/canvas/',{timeout:3000},s=>{process.exit(s.statusCode<500?0:1)});r.on('error',()=>process.exit(1));r.on('timeout',()=>{r.destroy();process.exit(1)})"]
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 15s
