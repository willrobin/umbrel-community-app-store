version: "3.7"

services:
  server:
    image: ghcr.io/music-assistant/server:2.7.5
    restart: unless-stopped
    network_mode: host
    # Webserver (UI) on port 8096, stream server on port 8097
    # Port 8095 is often in use by other services, so we use 8096
    cap_add:
      - SYS_ADMIN
      - DAC_READ_SEARCH
    security_opt:
      - apparmor:unconfined
    environment:
      LOG_LEVEL: info
    entrypoint: /bin/sh
    command:
      - -c
      - |
        # Pre-configure webserver port to 8096 to avoid port conflicts
        # Music Assistant stores settings in .storage subdirectory
        STORAGE_DIR="/data/.storage"
        SETTINGS_FILE="$$STORAGE_DIR/settings.json"

        # Ensure storage directory exists
        mkdir -p "$$STORAGE_DIR"

        # Configure settings with correct ports
        # Music Assistant stores core module configs under 'core/{module}/values/{key}'
        python3 -c "
        import json
        import os

        settings_file = '$$SETTINGS_FILE'
        settings = {}

        # Load existing settings if present
        if os.path.exists(settings_file):
            try:
                with open(settings_file, 'r') as f:
                    settings = json.load(f)
                print(f'Loaded existing settings from {settings_file}')
            except Exception as e:
                print(f'Could not load settings: {e}')
                settings = {}

        # Ensure core config structure exists
        if 'core' not in settings:
            settings['core'] = {}

        # Ensure webserver config exists under core with port 8096
        if 'webserver' not in settings['core']:
            settings['core']['webserver'] = {'values': {}, 'domain': 'webserver'}
        if 'values' not in settings['core']['webserver']:
            settings['core']['webserver']['values'] = {}

        # Always set port to 8096 to avoid conflicts with default 8095
        current_port = settings['core']['webserver']['values'].get('port', 8095)
        if current_port == 8095:
            settings['core']['webserver']['values']['port'] = 8096
            print('Set webserver port to 8096')
        else:
            print(f'Webserver port already configured: {current_port}')

        # Ensure streams config exists under core with port 8097
        if 'streams' not in settings['core']:
            settings['core']['streams'] = {'values': {}, 'domain': 'streams'}
        if 'values' not in settings['core']['streams']:
            settings['core']['streams']['values'] = {}
        if settings['core']['streams']['values'].get('port', 8097) == 8097:
            settings['core']['streams']['values']['port'] = 8097

        # Write settings
        with open(settings_file, 'w') as f:
            json.dump(settings, f, indent=2)
        print(f'Settings saved to {settings_file}')
        "

        # Start the Music Assistant server
        exec python3 -m music_assistant --config /data
    volumes:
      - ${APP_DATA_DIR}/data:/data
      - ${APP_DATA_DIR}/media:/media
