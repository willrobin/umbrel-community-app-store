version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: kasa-azuracast_web_1
      APP_PORT: 80

  web:
    image: ghcr.io/azuracast/azuracast:0.20.3
    init: true
    restart: unless-stopped
    stop_grace_period: 1m
    environment:
      # AzuraCast uses internal MariaDB and Redis by default
      # These environment variables configure the internal services
      MYSQL_ROOT_PASSWORD: "${APP_SEED}"
      APPLICATION_ENV: production
      LANG: en_US.UTF-8
      # Disable auto-update (Umbrel handles updates)
      ENABLE_WEB_UPDATER: "false"
      # Port range for streaming stations
      AUTO_ASSIGN_PORT_MIN: "8000"
      AUTO_ASSIGN_PORT_MAX: "8010"
    ports:
      # Streaming ports for radio stations
      - "8000:8000"
      - "8001:8001"
      - "8002:8002"
      - "8003:8003"
      - "8004:8004"
      - "8005:8005"
      - "8006:8006"
      - "8007:8007"
      - "8008:8008"
      - "8009:8009"
      - "8010:8010"
    volumes:
      # Main AzuraCast data directories - uses named volumes for proper initialization
      - station_data:/var/azuracast/stations
      - backups:/var/azuracast/backups
      - db_data:/var/lib/mysql
      - www_uploads:/var/azuracast/uploads
      - shoutcast2_install:/var/azuracast/servers/shoutcast2
      - stereo_tool_install:/var/azuracast/servers/stereo_tool
      - geolite_install:/var/azuracast/geoip
      - sftpgo_data:/var/azuracast/sftpgo/persist
      - acme_data:/var/azuracast/acme
      - tmp_data:/var/azuracast/www_tmp
      # External media access - read-write for metadata storage
      - ${APP_DATA_DIR}/media:/var/azuracast/media

volumes:
  station_data:
  backups:
  db_data:
  www_uploads:
  shoutcast2_install:
  stereo_tool_install:
  geolite_install:
  sftpgo_data:
  acme_data:
  tmp_data:
