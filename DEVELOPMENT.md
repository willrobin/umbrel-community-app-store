# Development

## Requirements
- git
- Optional: `yamllint`
- Optional: python3

## Local Workflow
1) One-time remote setup:
   `./scripts/setup-remotes.sh`
2) Keep remotes in sync:
   `git fetch --all --prune`
3) Create a new app scaffold:
   `./scripts/new-app.sh <app-id> "<App Name>"`
4) Edit `apps/<app-id>/umbrel-app.yml`, `docker-compose.yml`, `README.md`.
5) Publish to repo root:
   `./scripts/publish.sh`
6) Validate:
   `./scripts/validate.sh`
7) Commit and push:
   `git push origin <branch>`

## Umbrel App Discovery

**Important:** Umbrel discovers apps from the **repository root**, not from `apps/`.

We use a two-directory workflow:
1. **Development** in `apps/<app-id>/` (source of truth)
2. **Publishing** to `<repo-root>/<app-id>/` via `./scripts/publish.sh`

```
apps/kasa-app/           →  publish.sh  →   kasa-app/
(edit here)                               (Umbrel reads this)
```

**What publish.sh copies:**
- `umbrel-app.yml`
- `docker-compose.yml`
- `README.md`
- `icon.png` (if present)

**WARNING:** Never manually edit or delete root-level app directories.
They are auto-generated by publish.sh and should be treated as build artifacts.

## Git Remote Sync

This repository uses:
- `origin` fetch from Forgejo (`umbrel.local`)
- `origin` push to Forgejo and GitHub
- `github` remote for explicit fetch/compare

Detailed guide:
- `docs/git-remote-sync.md`

Quick commands:

```bash
git remote -v
git rev-list --left-right --count HEAD...origin/main
git rev-list --left-right --count HEAD...github/main
```

## Validation Rules (important)

`./scripts/validate.sh` currently enforces:
- Required app files in both `apps/<id>/` and root `<id>/`
- Unique manifest ports and host port conflict detection
- `APP_HOST` format: `<app-id>_<service>_1`
- Missing `APP_PORT` detection (unless `network_mode: host`)
- App IDs must be prefixed with store ID (from `umbrel-app-store.yml`)
- Basic committed-secret guardrails for common secret keys in compose files

## Git Hooks (auto commit messages)
- Enable once per clone:
  `./scripts/setup-githooks.sh`

## Umbrel Store Metadata
- `umbrel-app-store.yml` describes the store itself. It does not list apps.
