# CLAUDE.md - AI Assistant Guide for Umbrel Community App Store

> Comprehensive guide for AI assistants working on the Kasa (傘) Umbrel Community App Store

**Last Updated**: 2026-01-08
**Repository**: umbrel-community-app-store
**Purpose**: Community app store for Umbrel OS

## Table of Contents

1. [Repository Overview](#repository-overview)
2. [Repository Structure](#repository-structure)
3. [App Architecture](#app-architecture)
4. [Development Workflow](#development-workflow)
5. [Configuration Files](#configuration-files)
6. [Automation Scripts](#automation-scripts)
7. [Validation & Testing](#validation--testing)
8. [Git Workflow](#git-workflow)
9. [Security & Best Practices](#security--best-practices)
10. [Common Patterns](#common-patterns)
11. [Quick Reference](#quick-reference)

---

## Repository Overview

### What is Kasa?

**Kasa (傘)** means "umbrella" in Japanese, referencing Umbrel's logo. This is an independent community app store for Umbrel OS, not affiliated with the official Umbrel team.

### Key Characteristics

- **Dual-location pattern**: Apps maintained in `apps/<app-id>/` (source of truth), published to repo root (for Umbrel discovery)
- **Four active apps**: kasa-azuracast, kasa-calcom, kasa-paperless-ai, kasa-paperless-gpt
- **Port range**: UI ports 3001-3004, streaming ports 20000-20050 (AzuraCast only)
- **Language**: Primary documentation in German, code and technical docs in English
- **Automation**: Comprehensive validation, scaffolding, and git hook scripts

---

## Repository Structure

```
/home/user/umbrel-community-app-store/
│
├── apps/                           # SOURCE OF TRUTH - All app development happens here
│   ├── kasa-azuracast/            # Each app has required structure
│   ├── kasa-calcom/
│   ├── kasa-paperless-ai/
│   └── kasa-paperless-gpt/
│
├── kasa-azuracast/                # PUBLISHED COPIES - Generated by scripts/publish.sh
├── kasa-calcom/                   # Umbrel discovers apps here (repo root)
├── kasa-paperless-ai/
├── kasa-paperless-gpt/
│
├── scripts/                       # Automation tools
│   ├── new-app.sh                # App scaffolding
│   ├── publish.sh                # Copy apps to root
│   ├── validate.sh               # Comprehensive validation
│   └── setup-githooks.sh         # Configure git hooks
│
├── templates/                     # Scaffolding templates
│   ├── umbrel-app.yml.template
│   └── docker-compose.yml.template
│
├── docs/                          # Additional documentation
│   └── app-checklist.md          # Pre-submission checklist
│
├── .githooks/                     # Git automation
│   └── prepare-commit-msg        # Auto-generate commit messages
│
├── .editorconfig                  # Code style enforcement
├── umbrel-app-store.yml           # Store metadata (id: "kasa", name: "Kasa")
│
└── Documentation files
    ├── README.md                  # Main store info (German)
    ├── DEVELOPMENT.md             # Developer workflow
    ├── CONTRIBUTING.md            # Contribution guidelines
    ├── AGENTS.md                  # AI agent guidelines
    └── CLAUDE.md                  # This file
```

### Critical Path Understanding

**Always work in `apps/<app-id>/`**, then run `./scripts/publish.sh` to update the root copies. Never directly edit files in the root app directories.

---

## App Architecture

### Required Structure Per App

Each app **must** contain exactly these three files:

```
apps/<app-id>/
├── umbrel-app.yml        # REQUIRED - Umbrel manifest
├── docker-compose.yml    # REQUIRED - Docker service definitions
├── README.md             # REQUIRED - User documentation
└── icon.png              # OPTIONAL - App icon (recommended)
```

### Current Apps Overview

| App ID | Name | Description | Port | Special Notes |
|--------|------|-------------|------|---------------|
| `kasa-azuracast` | AzuraCast | Radio streaming management | 3004 | Uses ports 20000-20050 for streaming |
| `kasa-calcom` | Cal.com | Open-source scheduling | 3002 | - |
| `kasa-paperless-ai` | Paperless-AI | AI tagging for Paperless-ngx | 3001 | Requires Paperless-ngx |
| `kasa-paperless-gpt` | Paperless-GPT | LLM-powered OCR | 3003 | Requires Paperless-ngx + LLM |

### Naming Conventions

- **App IDs**: Lowercase letters, numbers, dashes only (e.g., `kasa-azuracast`)
- **Prefix**: All apps use `kasa-` prefix for community store identity
- **Docker service format**: `APP_HOST` must match `<app-id>_<service-name>_1`
  - Example: `kasa-azuracast_web_1` for the `web` service in `kasa-azuracast`

---

## Development Workflow

### Complete Workflow (5 Steps)

```bash
# 1. Create new app scaffold
./scripts/new-app.sh <app-id> "<App Name>"

# 2. Edit app files in apps/<app-id>/
#    - umbrel-app.yml (manifest)
#    - docker-compose.yml (services)
#    - README.md (documentation)

# 3. Publish to repo root (for Umbrel discovery)
./scripts/publish.sh

# 4. Validate all requirements
./scripts/validate.sh

# 5. Commit and push (git hook auto-generates message)
git add .
git commit
git push
```

### One-Time Setup

```bash
# Enable automatic commit message generation
./scripts/setup-githooks.sh
```

### Quick Edits to Existing Apps

```bash
# 1. Edit files in apps/<app-id>/
# 2. Publish changes
./scripts/publish.sh

# 3. Validate
./scripts/validate.sh

# 4. Commit
git commit -am "chore(apps): update <app-id>"
```

---

## Configuration Files

### 1. umbrel-app.yml (Manifest)

**Location**: `apps/<app-id>/umbrel-app.yml`
**Format**: YAML
**Purpose**: Defines app metadata for Umbrel UI

#### Required Fields

```yaml
manifestVersion: 1                    # Always 1
id: kasa-example                      # Must match directory name
name: Example App                     # Display name in UI
tagline: Short description           # One-line tagline
icon: https://raw.githubusercontent.com/...  # Icon URL
category: Media                       # Category: Media, Developer, Files, etc.
version: "0.1.0"                     # Semantic versioning (quoted)
port: 3005                           # Unique UI port (must be unique!)
description: >-                      # Full multi-line description
  Detailed description of the app...

developer: Original Developer         # Original project developer
website: https://example.com         # Project website
submitter: Kasa                      # Who submitted to store
submission: https://github.com/...   # Submission/source URL
repo: https://github.com/...         # Repository URL
support: https://github.com/.../issues  # Support/issue tracker
gallery: []                          # Screenshot URLs (array)
releaseNotes: >-                     # Version-specific release notes
  Initial release on Kasa store.

dependencies: []                     # App dependencies (array)
path: ""                            # Path configuration (usually empty)
defaultUsername: ""                  # Default credentials (if any)
defaultPassword: ""
```

#### Port Assignment Rules

- **UI Ports**: 3001-3004 currently used, assign next available
- **Special Ports**: Document any host port ranges (e.g., 20000-20050 for streaming)
- **Uniqueness**: Run `./scripts/validate.sh` to check port conflicts

### 2. docker-compose.yml (Services)

**Location**: `apps/<app-id>/docker-compose.yml`
**Format**: Docker Compose v3.7+
**Purpose**: Defines all Docker services for the app

#### Required Components

##### app_proxy Service (Required)

```yaml
version: "3.7"

services:
  app_proxy:
    environment:
      # Format: <app-id>_<service-name>_1
      APP_HOST: kasa-example_web_1
      APP_PORT: 80
```

**Critical**: `APP_HOST` must match the naming pattern: `<app-id>_<service-name>_1`

##### Main Application Service

```yaml
  web:
    image: ghcr.io/example/app:stable
    init: true                        # Recommended for proper signal handling
    restart: unless-stopped           # Standard restart policy
    environment:
      # App-specific environment variables
      DATABASE_HOST: db
      DATABASE_PASSWORD: "${APP_SEED}"  # Use APP_SEED for generated secrets
    volumes:
      # Always use ${APP_DATA_DIR} for persistence
      - ${APP_DATA_DIR}/app:/data
    # ports:                          # Avoid host ports unless necessary
    #   - "8080:8080"                # Document in README if used
```

#### Umbrel Environment Variables

These are provided by Umbrel OS and available to all apps:

##### Standard Variables (Always Available)

```yaml
${APP_DATA_DIR}              # Per-app persistent data directory (PREFERRED)
${APP_SEED}                  # Auto-generated secret for passwords/tokens
${DEVICE_HOSTNAME}           # Umbrel device hostname
${DEVICE_DOMAIN_NAME}        # Umbrel device domain
${APP_PASSWORD}              # App-specific password (if configured)
${APP_HIDDEN_SERVICE}        # Tor hidden service address (if enabled)
```

##### Bitcoin/Lightning Variables (If dependencies declared)

```yaml
${APP_BITCOIN_NODE_IP}
${APP_BITCOIN_RPC_PORT}
${APP_BITCOIN_RPC_USER}
${APP_BITCOIN_RPC_PASS}
${APP_BITCOIN_DATA_DIR}
${APP_LIGHTNING_NODE_DATA_DIR}
${TOR_PROXY_IP}
${TOR_PROXY_PORT}
```

##### Path Best Practices

```yaml
# ✅ CORRECT - Use APP_DATA_DIR
volumes:
  - ${APP_DATA_DIR}/web:/data
  - ${APP_DATA_DIR}/db:/var/lib/mysql

# ❌ WRONG - Don't use hardcoded paths
volumes:
  - /data/app:/data
  - ./data:/data
```

### 3. README.md (Documentation)

**Location**: `apps/<app-id>/README.md`
**Format**: Markdown
**Purpose**: User-facing app documentation

#### Required Sections

```markdown
# App Name

Brief overview of what the app does.

## Features

- Key feature 1
- Key feature 2
- Key feature 3

## Configuration

### Ports

- UI Port: 3004
- Additional ports: 20000-20050 (if applicable)

### Volumes

- `${APP_DATA_DIR}/app` - Application data
- `${APP_DATA_DIR}/db` - Database data

### Environment Variables

- `APP_SEED` - Used for database password
- `CUSTOM_VAR` - Purpose of custom variable

## Dependencies

List any dependencies on other apps (e.g., Paperless-ngx, Bitcoin node).

## Usage

Step-by-step instructions for initial setup and basic usage.

## Notes

Any important notes, limitations, or known issues.
```

---

## Automation Scripts

### 1. new-app.sh - App Scaffolding

**Purpose**: Create new app structure from templates

```bash
./scripts/new-app.sh <app-id> "<App Name>"
```

**What it does**:
- Validates app-id format (lowercase, numbers, dashes only)
- Creates `apps/<app-id>/` directory
- Generates files from templates using sed substitution
- Creates starter README

**Example**:
```bash
./scripts/new-app.sh kasa-myapp "My Awesome App"
```

### 2. publish.sh - Publish Apps to Root

**Purpose**: Copy apps from `apps/` to repo root for Umbrel discovery

```bash
./scripts/publish.sh
```

**What it does**:
- Validates required files exist in `apps/<app-id>/`
- Copies `umbrel-app.yml`, `docker-compose.yml`, `README.md`, `icon.png` to `<app-id>/`
- Ensures Umbrel can discover apps at root level
- Must run after any changes to app files

**When to use**: After editing any files in `apps/<app-id>/`

### 3. validate.sh - Comprehensive Validation

**Purpose**: Validate all app requirements and configurations

```bash
./scripts/validate.sh
```

**What it validates**:
- ✅ Required files present (`umbrel-app.yml`, `docker-compose.yml`, `README.md`)
- ✅ Files exist in both `apps/` and root locations
- ✅ Port uniqueness across all apps (no conflicts)
- ✅ `APP_PORT` environment variable exists in docker-compose.yml
- ✅ Host port range conflicts (e.g., 20000-20050)
- ✅ YAML syntax validity (if `yamllint` available)

**Exit codes**:
- `0` - All validations passed
- `1` - One or more validations failed

**Always run before committing!**

### 4. setup-githooks.sh - Git Hook Installation

**Purpose**: Enable automatic commit message generation

```bash
./scripts/setup-githooks.sh
```

**What it does**:
- Configures git to use `.githooks/` directory
- One-time setup per repository clone
- Enables `prepare-commit-msg` hook

---

## Validation & Testing

### Pre-Commit Checklist

Before committing changes, ensure:

```bash
# 1. Publish changes to root
./scripts/publish.sh

# 2. Run validation
./scripts/validate.sh

# 3. Check git status
git status

# 4. Review changes
git diff

# 5. Commit (message auto-generated by hook)
git commit
```

### Manual Validation Steps

#### Check Port Uniqueness
```bash
grep -r "^port:" apps/*/umbrel-app.yml
```

#### Verify APP_DATA_DIR Usage
```bash
grep -r "APP_DATA_DIR" apps/*/docker-compose.yml
```

#### Check APP_HOST Format
```bash
grep -r "APP_HOST:" apps/*/docker-compose.yml
```

#### Validate YAML Syntax
```bash
yamllint apps/*/umbrel-app.yml
yamllint apps/*/docker-compose.yml
```

---

## Git Workflow

### Branch Strategy

- **Main branch**: Direct commits for small changes
- **Feature branches**: Optional for larger features
- **No complex branching**: Simple linear history preferred

### Commit Message Format

**Automated by git hook** (`.githooks/prepare-commit-msg`)

Format: `type(scope): subject`

#### Types
- `feat` - New feature or app
- `chore` - Maintenance, updates, refactoring
- `docs` - Documentation changes
- `fix` - Bug fixes

#### Scopes
- `apps` - App-specific changes
- `scripts` - Script modifications
- `templates` - Template updates
- `docs` - Documentation
- `store` - Store metadata

#### Examples
```
feat(apps): add kasa-myapp
chore(apps): update kasa-azuracast to v2.0
docs(README): update port information
fix(scripts): correct validation logic
```

### Commit Best Practices

1. **Small, focused commits** - One logical change per commit
2. **Descriptive subjects** - Clear what changed and why
3. **Body for complex changes** - Explain migrations or breaking changes
4. **Test before commit** - Always run `./scripts/validate.sh`

### Git Hook Behavior

The `prepare-commit-msg` hook automatically:
- Detects changed files
- Determines appropriate type and scope
- Includes app-id if app files changed
- Generates commit message
- Skips for merge/squash commits

---

## Security & Best Practices

### Security Checklist

#### Container Security
- ✅ Use non-root containers where possible
- ✅ Pin image tags (avoid `latest`)
- ✅ Use `init: true` for proper signal handling

#### Port Exposure
- ✅ Avoid host `ports:` unless necessary
- ✅ Prefer `app_proxy` for UI access
- ✅ Document all exposed ports in README

#### Data Persistence
- ✅ Use `${APP_DATA_DIR}` for all persistent data
- ✅ Organize volumes by service: `${APP_DATA_DIR}/web`, `${APP_DATA_DIR}/db`
- ✅ Avoid bind mounts to host filesystem

#### Secrets Management
- ✅ Use `${APP_SEED}` for auto-generated passwords
- ✅ Never commit secrets or credentials
- ✅ Use environment variables for sensitive data
- ✅ Document required secrets in README

#### Environment Variables
- ✅ Prefer Umbrel-provided variables over custom paths
- ✅ Document all custom environment variables
- ✅ Use secure defaults

### Code Style (.editorconfig)

```ini
[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true

[*.{yml,yaml,sh}]
indent_style = space
indent_size = 2

[*.md]
max_line_length = 100
```

### YAML Best Practices

```yaml
# ✅ CORRECT - Multi-line strings with >-
description: >-
  This is a long description that
  will be folded into a single line.

# ✅ CORRECT - Quoted numeric strings
version: "0.1.0"
port: 3004

# ✅ CORRECT - Empty strings and arrays
path: ""
gallery: []
dependencies: []

# ❌ WRONG - Unquoted version
version: 0.1.0

# ❌ WRONG - Missing arrays
gallery:
dependencies:
```

---

## Common Patterns

### Pattern 1: Simple Single-Service App

**Use case**: Single container app with no dependencies

```yaml
# umbrel-app.yml
port: 3005

# docker-compose.yml
version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: kasa-myapp_web_1
      APP_PORT: 3000

  web:
    image: example/app:latest
    init: true
    restart: unless-stopped
    volumes:
      - ${APP_DATA_DIR}/data:/data
```

### Pattern 2: App with Database

**Use case**: Web app with separate database service

```yaml
# docker-compose.yml
services:
  app_proxy:
    environment:
      APP_HOST: kasa-myapp_web_1
      APP_PORT: 8080

  web:
    image: example/app:latest
    init: true
    restart: unless-stopped
    depends_on:
      - db
    environment:
      DATABASE_URL: postgresql://user:${APP_SEED}@db:5432/myapp
    volumes:
      - ${APP_DATA_DIR}/app:/app/data

  db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: user
      POSTGRES_PASSWORD: ${APP_SEED}
    volumes:
      - ${APP_DATA_DIR}/postgres:/var/lib/postgresql/data
```

### Pattern 3: Multi-Service App with Host Ports

**Use case**: App requiring additional host port exposure (streaming, etc.)

```yaml
# umbrel-app.yml
port: 3004

# docker-compose.yml (see kasa-azuracast for full example)
services:
  app_proxy:
    environment:
      APP_HOST: kasa-myapp_web_1
      APP_PORT: 80

  web:
    # ... main service config

  streaming:
    image: example/streaming:latest
    restart: unless-stopped
    ports:
      - "20000-20050:20000-20050"  # Document in README!
    volumes:
      - ${APP_DATA_DIR}/streams:/streams
```

### Pattern 4: App with External Dependencies

**Use case**: App requiring another Umbrel app (e.g., Paperless-ngx)

```yaml
# umbrel-app.yml
dependencies: []  # Note: Currently not enforced by Umbrel
description: >-
  This app requires Paperless-ngx to be installed.
  ...

# README.md
## Dependencies

This app requires:
- Paperless-ngx (install from Umbrel App Store)
- Connection details: http://paperless-ngx:8000

## Configuration

Set the following environment variables in docker-compose.yml:
- PAPERLESS_URL: http://paperless-ngx:8000
- PAPERLESS_TOKEN: (obtain from Paperless-ngx settings)
```

---

## Quick Reference

### Essential Commands

```bash
# Create new app
./scripts/new-app.sh <app-id> "<App Name>"

# Publish to root (after editing)
./scripts/publish.sh

# Validate everything
./scripts/validate.sh

# Setup git hooks (once per clone)
./scripts/setup-githooks.sh

# Check for port conflicts
grep -r "^port:" apps/*/umbrel-app.yml
```

### File Locations

| Purpose | Source | Published | Notes |
|---------|--------|-----------|-------|
| App files | `apps/<app-id>/` | `<app-id>/` | Always edit in `apps/` |
| Scripts | `scripts/` | N/A | Automation tools |
| Templates | `templates/` | N/A | For `new-app.sh` |
| Git hooks | `.githooks/` | N/A | Auto commit messages |
| Store config | `umbrel-app-store.yml` | N/A | Store metadata |

### Port Assignments

| Port Range | Purpose | Apps |
|------------|---------|------|
| 3001 | UI | kasa-paperless-ai |
| 3002 | UI | kasa-calcom |
| 3003 | UI | kasa-paperless-gpt |
| 3004 | UI | kasa-azuracast |
| 3005+ | UI | Available for new apps |
| 20000-20050 | Streaming | kasa-azuracast |

### Umbrel Variables Quick Reference

```bash
# Paths
${APP_DATA_DIR}                    # Per-app data (use this!)
${UMBREL_ROOT}                     # Umbrel root (avoid)

# Identity
${DEVICE_HOSTNAME}                 # Device hostname
${DEVICE_DOMAIN_NAME}              # Device domain

# Secrets
${APP_SEED}                        # Auto-generated secret
${APP_PASSWORD}                    # App password (if set)

# Network
${TOR_PROXY_IP}                    # Tor proxy IP
${TOR_PROXY_PORT}                  # Tor proxy port
${APP_HIDDEN_SERVICE}              # Tor hidden service
```

### Validation Checklist

Before committing, verify:

- [ ] Edited files in `apps/<app-id>/` (not root)
- [ ] Ran `./scripts/publish.sh`
- [ ] Ran `./scripts/validate.sh` (exits 0)
- [ ] Port is unique across all apps
- [ ] Used `${APP_DATA_DIR}` for volumes
- [ ] `APP_HOST` format is `<app-id>_<service>_1`
- [ ] No secrets committed
- [ ] README.md documents configuration
- [ ] Updated `releaseNotes` if version changed

---

## Working with AI Assistants

### For AI Assistants Reading This

When working on this repository:

1. **Always read before editing** - Never propose changes to files you haven't read
2. **Work in source directory** - Edit `apps/<app-id>/`, not root directories
3. **Follow the workflow** - Scaffold → Edit → Publish → Validate → Commit
4. **Run validation** - Always run `./scripts/validate.sh` before committing
5. **Check existing patterns** - Look at existing apps for examples
6. **Document everything** - Update READMEs when behavior changes
7. **Keep changes minimal** - Don't over-engineer or add unnecessary features
8. **Security first** - Never commit secrets, validate port exposure
9. **Test assumptions** - Verify port uniqueness, variable usage, file structure

### Common AI Assistant Tasks

#### Adding a New App
```bash
# 1. Scaffold
./scripts/new-app.sh kasa-newapp "New App"

# 2. Read and customize
# - apps/kasa-newapp/umbrel-app.yml
# - apps/kasa-newapp/docker-compose.yml
# - apps/kasa-newapp/README.md

# 3. Validate and commit
./scripts/publish.sh && ./scripts/validate.sh && git add . && git commit
```

#### Updating an Existing App
```bash
# 1. Read current files
cat apps/kasa-example/umbrel-app.yml
cat apps/kasa-example/docker-compose.yml

# 2. Make changes in apps/ directory

# 3. Validate and commit
./scripts/publish.sh && ./scripts/validate.sh && git commit -am "chore(apps): update kasa-example"
```

#### Fixing Validation Errors
```bash
# Run validation to see errors
./scripts/validate.sh

# Fix issues in apps/ directory
# Common issues:
# - Port conflicts → Change port in umbrel-app.yml
# - Missing APP_PORT → Add to app_proxy environment
# - Wrong APP_HOST format → Use <app-id>_<service>_1

# Re-validate
./scripts/publish.sh && ./scripts/validate.sh
```

---

## Additional Resources

### External Documentation

- [Umbrel App Framework](https://github.com/getumbrel/umbrel-apps) - Official Umbrel app documentation
- [Docker Compose Specification](https://docs.docker.com/compose/compose-file/) - Docker Compose reference
- [YAML Specification](https://yaml.org/spec/) - YAML format specification

### Repository Documentation

- `README.md` - Store overview (German)
- `DEVELOPMENT.md` - Development workflow
- `CONTRIBUTING.md` - Contribution guidelines
- `AGENTS.md` - AI agent guidelines
- `docs/app-checklist.md` - Pre-submission checklist

### Support

- **Issues**: Open GitHub issue in this repository
- **Questions**: See existing app examples for patterns
- **Community**: Umbrel community forums and Discord

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2026-01-08 | Initial comprehensive CLAUDE.md created |

---

**End of CLAUDE.md**
